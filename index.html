<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Image Marker Tool</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* === ENHANCED 3D-STYLE CSS === */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { display: flex; flex-direction: column; height: 100vh; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #e6e6e6; overflow: hidden; }
        
        /* Header */
        .header { 
            background: rgba(0, 0, 0, 0.7); 
            padding: 15px 20px; 
            border-bottom: 2px solid #00b4d8; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-shrink: 0; 
        }
        .header h1 { 
            color: #00b4d8; 
            font-size: 2rem; 
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header-controls { display: flex; gap: 10px; }
        
        /* Main container layout */
        .main-container { 
            display: flex; 
            flex: 1; 
            overflow: hidden; 
        }
        
        /* Left panel styling */
        .left-panel { 
            width: 320px; 
            background: rgba(30, 30, 46, 0.9); 
            padding: 20px; 
            overflow-y: auto; 
            border-right: 1px solid #444; 
            flex-shrink: 0; 
        }
        .panel-section { 
            margin-bottom: 25px; 
            padding-bottom: 20px; 
            border-bottom: 1px solid #444; 
        }
        .panel-section h3 { 
            color: #00b4d8; 
            margin-bottom: 15px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        
        /* Upload area */
        .upload-area { 
            border: 3px dashed #00b4d8; 
            border-radius: 10px; 
            padding: 30px 20px; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.3s; 
            background: rgba(0, 180, 216, 0.05); 
            margin-bottom: 20px; 
            position: relative;
        }
        .upload-area.dragover { 
            background: rgba(0, 180, 216, 0.2); 
            border-color: #90e0ef; 
        }
        .upload-area:hover { 
            background: rgba(0, 180, 216, 0.1); 
            border-color: #90e0ef; 
        }
        .upload-area i { 
            font-size: 48px; 
            color: #00b4d8; 
            margin-bottom: 15px; 
        }
        .upload-area p { margin: 10px 0; }
        .upload-area .file-info { 
            font-size: 0.9rem; 
            color: #aaa; 
        }
        
        /* Button styles */
        .button { 
            display: inline-block; 
            padding: 12px 20px; 
            margin: 5px 0; 
            border: none; 
            border-radius: 6px; 
            background: #00b4d8; 
            color: white; 
            font-weight: bold; 
            cursor: pointer; 
            transition: all 0.3s; 
            text-align: center; 
            text-decoration: none;
        }
        .button:hover { 
            background: #0077b6; 
            transform: translateY(-2px); 
        }
        .button:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }
        .button.full { width: 100%; }
        .button.secondary { background: #444; }
        .button.secondary:hover { background: #555; }
        .button.danger { background: #e63946; }
        .button.danger:hover { background: #d00000; }
        .button.warning { background: #f8961e; color: #000; }
        .button.warning:hover { background: #e68a1b; }
        .button i { margin-right: 8px; }
        
        /* Marker type selector */
        .marker-type-selector { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
            margin-bottom: 15px; 
        }
        .marker-type { 
            padding: 10px; 
            border: 2px solid transparent; 
            border-radius: 6px; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.2s; 
            background: rgba(255, 255, 255, 0.05); 
        }
        .marker-type.selected { 
            border-color: #00b4d8; 
            background: rgba(0, 180, 216, 0.1); 
        }
        .marker-type i { 
            font-size: 20px; 
            margin-bottom: 5px; 
            display: block; 
        }
        /* Marker type colors */
        .marker-type.info { color: #4cc9f0; }
        .marker-type.link { color: #4361ee; }
        .marker-type.video { color: #f72585; }
        .marker-type.audio { color: #7209b7; }
        .marker-type.warning { color: #f8961e; }
        .marker-type.question { color: #2a9d8f; }
        
        /* Form styles */
        .marker-form input, 
        .marker-form textarea { 
            width: 100%; 
            padding: 10px; 
            margin-bottom: 12px; 
            border: 1px solid #555; 
            border-radius: 4px; 
            background: rgba(255, 255, 255, 0.1); 
            color: white; 
        }
        .marker-form textarea { 
            height: 80px; 
            resize: vertical; 
        }
        .url-field { display: none; }
        .url-field.visible { display: block; }
        
        /* Marker list */
        .marker-list { 
            max-height: 300px; 
            overflow-y: auto; 
        }
        .marker-item { 
            background: rgba(255, 255, 255, 0.05); 
            border-left: 4px solid #00b4d8; 
            padding: 12px; 
            margin-bottom: 10px; 
            border-radius: 4px; 
            cursor: pointer; 
            transition: all 0.2s; 
            display: flex;
            flex-direction: column;
        }
        .marker-item:hover { 
            background: rgba(255, 255, 255, 0.1); 
        }
        .marker-item.selected { 
            background: rgba(0, 180, 216, 0.15); 
        }
        .marker-item-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .marker-item-title { 
            font-weight: bold; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        .marker-item-type { 
            font-size: 0.8rem; 
            padding: 2px 8px; 
            border-radius: 10px; 
            background: rgba(255, 255, 255, 0.1); 
        }
        .marker-item-description { 
            font-size: 0.9rem; 
            color: #aaa; 
            margin-top: 5px; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
        }
        .marker-item-actions { 
            display: flex; 
            gap: 5px; 
            margin-top: 10px; 
        }
        .marker-action-btn { 
            padding: 4px 10px; 
            border: none; 
            border-radius: 4px; 
            font-size: 0.8rem; 
            cursor: pointer; 
        }
        .marker-action-btn.edit { 
            background: #00b4d8; 
            color: white; 
        }
        .marker-action-btn.delete { 
            background: #e63946; 
            color: white; 
        }
        
        /* Viewer container */
        .viewer-container { 
            flex: 1; 
            position: relative; 
            overflow: hidden; 
            padding: 20px; 
        }
        
        /* Image container */
        .image-container { 
            width: 100%; 
            height: 100%; 
            border: 2px dashed #444; 
            border-radius: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            overflow: hidden; 
            background: rgba(0, 0, 0, 0.3); 
            cursor: crosshair;
        }
        
        /* Image display */
        #imageDisplay { 
            max-width: 100%; 
            max-height: 100%; 
            display: none; 
            object-fit: contain;
        }
        .empty-state { 
            text-align: center; 
            color: #aaa; 
            padding: 40px;
        }
        .empty-state i { 
            font-size: 48px; 
            margin-bottom: 20px; 
            color: #444; 
        }
        
        /* Markers */
        .marker { 
            position: absolute; 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            cursor: pointer; 
            transform: translate(-50%, -50%); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            font-size: 14px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.3); 
            transition: all 0.2s; 
            z-index: 10; 
        }
        .marker:hover { 
            transform: translate(-50%, -50%) scale(1.2); 
            z-index: 11;
        }
        .marker.selected { 
            border: 3px solid white; 
            box-shadow: 0 0 0 2px #00b4d8, 0 0 15px #00b4d8; 
        }
        .marker.preview { 
            opacity: 0.5; 
            z-index: 5; 
            pointer-events: none;
        }
        /* Marker colors */
        .marker.info { background: #4cc9f0; }
        .marker.link { background: #4361ee; }
        .marker.video { background: #f72585; }
        .marker.audio { background: #7209b7; }
        .marker.warning { background: #f8961e; }
        .marker.question { background: #2a9d8f; }
        
        /* Popup */
        .marker-popup { 
            position: absolute; 
            background: rgba(0, 0, 0, 0.95); 
            color: white; 
            padding: 15px; 
            border-radius: 8px; 
            border-left: 4px solid #00b4d8; 
            max-width: 300px; 
            min-width: 250px; 
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.7); 
            z-index: 1000; 
            pointer-events: auto; 
            backdrop-filter: blur(5px); 
            transition: opacity 0.3s ease; 
            font-size: 14px; 
            display: none; 
        }
        .popup-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px; 
        }
        .popup-title { 
            color: #00b4d8; 
            margin: 0; 
            flex: 1; 
            font-size: 16px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        .popup-close { 
            background: transparent; 
            border: none; 
            color: #aaa; 
            cursor: pointer; 
            font-size: 18px; 
            width: 24px; 
            height: 24px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 50%; 
            transition: all 0.2s; 
        }
        .popup-close:hover { 
            background: rgba(255, 255, 255, 0.1); 
            color: white; 
        }
        .popup-content { margin-bottom: 15px; }
        .popup-description { 
            color: #aaa; 
            line-height: 1.4; 
            margin-bottom: 10px; 
        }
        .popup-link { 
            color: #4cc9f0; 
            text-decoration: none; 
            display: block; 
            margin-top: 10px; 
            padding: 6px 12px; 
            background: rgba(76, 201, 240, 0.1); 
            border-radius: 4px; 
            transition: background 0.3s; 
            word-break: break-all;
        }
        .popup-link:hover { 
            background: rgba(76, 201, 240, 0.2); 
        }
        .popup-media { width: 100%; margin-top: 10px; }
        .video-container { 
            position: relative; 
            width: 100%; 
            height: 0; 
            padding-bottom: 56.25%; 
            margin-top: 10px; 
        }
        .video-container iframe { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            border: none; 
            border-radius: 4px; 
        }
        .popup-video, .popup-audio { width: 100%; border-radius: 4px; }
        
        /* Utility classes */
        .hidden { display: none !important; }
        .visible { display: block !important; }
        .search-box { margin-bottom: 15px; }
        .search-box input { 
            width: 100%; 
            padding: 10px; 
            border-radius: 4px; 
            background: rgba(255, 255, 255, 0.1); 
            border: 1px solid #555; 
            color: white; 
        }
        .form-buttons { display: flex; flex-wrap: wrap; gap: 10px; }
        .shortcut-hint { 
            font-size: 0.8rem; 
            color: #aaa; 
            margin-top: 10px; 
            text-align: center; 
        }
        .history-controls { display: flex; gap: 10px; margin-top: 10px; }
        
        /* Modals */
        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.8); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 1000; 
        }
        .modal { 
            background: #1a1a2e; 
            padding: 30px; 
            border-radius: 10px; 
            max-width: 800px; 
            width: 90%; 
            max-height: 80vh; 
            overflow-y: auto; 
            border: 2px solid #00b4d8; 
        }
        .modal h3 { 
            color: #00b4d8; 
            margin-bottom: 20px; 
            text-align: center; 
        }
        .modal textarea { 
            width: 100%; 
            height: 400px; 
            padding: 15px; 
            background: rgba(255, 255, 255, 0.05); 
            border: 1px solid #444; 
            border-radius: 5px; 
            color: white; 
            font-family: monospace; 
            font-size: 12px; 
            margin-bottom: 20px; 
            resize: none; 
            white-space: pre; 
            overflow-x: auto; 
        }
        .modal-buttons { display: flex; gap: 10px; justify-content: center; }
        
        /* Responsive */
        @media (max-width: 1024px) { 
            .main-container { flex-direction: column; } 
            .left-panel { width: 100%; max-height: 40vh; } 
        }
        @media (max-width: 768px) { 
            .header { flex-direction: column; gap: 10px; text-align: center; } 
            .marker-type-selector { grid-template-columns: repeat(2, 1fr); } 
            .button { padding: 10px 15px; } 
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <div class="header">
        <h1><i class="fas fa-map-marker-alt"></i> Image Marker Tool</h1>
        <div class="header-controls">
            <button class="button secondary" id="saveProjectBtn">
                <i class="fas fa-save"></i> Save Project
            </button>
            <button class="button secondary" id="loadProjectBtn">
                <i class="fas fa-folder-open"></i> Load Project
            </button>
            <button class="button secondary" id="exportBtn">
                <i class="fas fa-file-export"></i> Export HTML
            </button>
        </div>
    </div>

    <div class="main-container">
        <!-- LEFT PANEL -->
        <div class="left-panel">
            <div class="panel-section">
                <h3><i class="fas fa-upload"></i> Upload Image</h3>
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>Click or drag & drop to upload image</p>
                    <p class="file-info">Supported: JPG, PNG, GIF, WebP</p>
                    <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                </div>
                <div id="imageInfo" class="hidden">
                    <p><strong>Current Image:</strong> <span id="currentImageName">None</span></p>
                    <p><strong>Markers:</strong> <span id="markerCount">0</span></p>
                </div>
            </div>

            <div class="panel-section">
                <h3><i class="fas fa-map-marker-alt"></i> Add Marker</h3>
                <div class="marker-type-selector">
                    <div class="marker-type info selected" data-type="info">
                        <i class="fas fa-info-circle"></i>
                        <span>Info</span>
                    </div>
                    <div class="marker-type link" data-type="link">
                        <i class="fas fa-link"></i>
                        <span>Link</span>
                    </div>
                    <div class="marker-type video" data-type="video">
                        <i class="fas fa-video"></i>
                        <span>Video</span>
                    </div>
                    <div class="marker-type audio" data-type="audio">
                        <i class="fas fa-volume-up"></i>
                        <span>Audio</span>
                    </div>
                    <div class="marker-type warning" data-type="warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Warning</span>
                    </div>
                    <div class="marker-type question" data-type="question">
                        <i class="fas fa-question-circle"></i>
                        <span>Question</span>
                    </div>
                </div>

                <div class="marker-form">
                    <input type="text" id="markerTitle" class="form-control" placeholder="Marker title" required>
                    <textarea id="markerDescription" class="form-control" placeholder="Marker description"></textarea>
                    <input type="url" id="markerLink" class="form-control url-field" placeholder="https://example.com">
                    <input type="url" id="markerVideo" class="form-control url-field" placeholder="https://youtube.com/watch?v=...">
                    <input type="url" id="markerAudio" class="form-control url-field" placeholder="https://example.com/audio.mp3">
                    
                    <div class="form-buttons">
                        <button id="saveMarker" class="button full">
                            <i class="fas fa-save"></i> Save Marker
                        </button>
                        <button id="deleteMarker" class="button danger full" style="display: none;">
                            <i class="fas fa-trash"></i> Delete Marker
                        </button>
                        <button id="clearForm" class="button secondary full">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <h3><i class="fas fa-list"></i> Markers (<span id="markerListCount">0</span>)</h3>
                <div class="search-box">
                    <input type="text" id="markerSearch" placeholder="Search markers...">
                </div>
                <div class="marker-list" id="markerList">
                    <div class="empty-state">No markers added</div>
                </div>
                <button id="clearMarkers" class="button danger full">
                    <i class="fas fa-trash"></i> Clear All Markers
                </button>
            </div>

            <div class="panel-section">
                <h3><i class="fas fa-project-diagram"></i> Tools</h3>
                <div class="history-controls">
                    <button id="undoBtn" class="button warning" title="Undo (Ctrl+Z)" disabled>
                        <i class="fas fa-undo"></i> Undo
                    </button>
                    <button id="redoBtn" class="button warning" title="Redo (Ctrl+Y)" disabled>
                        <i class="fas fa-redo"></i> Redo
                    </button>
                </div>
                <div class="shortcut-hint">
                    Shortcuts: Ctrl+S (Save), Ctrl+O (Load), Ctrl+E (Export), Del (Delete), Esc (Cancel)
                </div>
            </div>
        </div>

        <!-- MAIN VIEWER AREA -->
        <div class="viewer-container">
            <div class="image-container" id="imageContainer">
                <div class="empty-state" id="emptyState">
                    <i class="fas fa-image"></i>
                    <div>Upload an image to get started</div>
                </div>
                <img id="imageDisplay" alt="Uploaded image">
                <div class="marker-popup" id="markerPopup">
                    <div class="popup-header">
                        <h4 class="popup-title" id="popupTitle"></h4>
                        <button class="popup-close" id="closePopup">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="popup-content">
                        <p class="popup-description" id="popupDescription"></p>
                        <a class="popup-link" id="popupLink" href="#" target="_blank" style="display: none;"></a>
                        <div class="popup-media" id="popupMedia"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal-overlay hidden" id="exportModal">
        <div class="modal">
            <h3><i class="fas fa-file-export"></i> Export as HTML</h3>
            <textarea id="exportCode" readonly></textarea>
            <div class="modal-buttons">
                <button class="button" id="copyCodeBtn"><i class="fas fa-copy"></i> Copy Code</button>
                <button class="button secondary" id="downloadBtn"><i class="fas fa-download"></i> Download HTML</button>
                <button class="button secondary" id="closeExportBtn"><i class="fas fa-times"></i> Close</button>
            </div>
        </div>
    </div>

    <!-- ENHANCED JAVASCRIPT -->
    <script>
        // Marker themes
        const markerThemes = {
            info: { color: '#4cc9f0', icon: 'info-circle' },
            link: { color: '#4361ee', icon: 'link' },
            video: { color: '#f72585', icon: 'video' },
            audio: { color: '#7209b7', icon: 'volume-up' },
            warning: { color: '#f8961e', icon: 'exclamation-triangle' },
            question: { color: '#2a9d8f', icon: 'question-circle' }
        };

        // State management
        let markers = [];
        let currentMarkerType = 'info';
        let selectedMarkerId = null;
        let currentImage = null;
        let previewMarker = null;
        let history = [];
        let historyIndex = -1;
        let isMouseOverImage = false;

        // DOM elements
        const fileInput = document.getElementById('imageUpload');
        const uploadArea = document.getElementById('uploadArea');
        const imageDisplay = document.getElementById('imageDisplay');
        const imageContainer = document.getElementById('imageContainer');
        const emptyState = document.getElementById('emptyState');
        const markerTypes = document.querySelectorAll('.marker-type');
        const markerTitle = document.getElementById('markerTitle');
        const markerDescription = document.getElementById('markerDescription');
        const markerLink = document.getElementById('markerLink');
        const markerVideo = document.getElementById('markerVideo');
        const markerAudio = document.getElementById('markerAudio');
        const saveMarker = document.getElementById('saveMarker');
        const deleteMarker = document.getElementById('deleteMarker');
        const clearForm = document.getElementById('clearForm');
        const clearMarkers = document.getElementById('clearMarkers');
        const markerList = document.getElementById('markerList');
        const saveProject = document.getElementById('saveProjectBtn');
        const loadProject = document.getElementById('loadProjectBtn');
        const exportHTML = document.getElementById('exportBtn');
        const markerPopup = document.getElementById('markerPopup');
        const popupTitle = document.getElementById('popupTitle');
        const popupDescription = document.getElementById('popupDescription');
        const popupLink = document.getElementById('popupLink');
        const popupMedia = document.getElementById('popupMedia');
        const closePopup = document.getElementById('closePopup');
        const markerSearch = document.getElementById('markerSearch');
        const undoBtn = document.getElementById('undoBtn');
        const redoBtn = document.getElementById('redoBtn');
        const copyCodeBtn = document.getElementById('copyCodeBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const closeExportBtn = document.getElementById('closeExportBtn');

        // Initialize app
        function init() {
            console.log('App initialized');
            
            // Event listeners
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleImageUpload);

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    const fakeEvent = { target: { files: e.dataTransfer.files } };
                    handleImageUpload(fakeEvent);
                }
            });

            // Marker type selection
            markerTypes.forEach(type => {
                type.addEventListener('click', () => {
                    markerTypes.forEach(t => t.classList.remove('selected'));
                    type.classList.add('selected');
                    currentMarkerType = type.dataset.type;
                    updateFieldsVisibility();
                });
            });

            // Form buttons
            saveMarker.addEventListener('click', saveMarkerHandler);
            deleteMarker.addEventListener('click', deleteMarkerHandler);
            clearForm.addEventListener('click', resetForm);
            clearMarkers.addEventListener('click', clearMarkersHandler);
            saveProject.addEventListener('click', saveProjectHandler);
            loadProject.addEventListener('click', loadProjectHandler);
            exportHTML.addEventListener('click', exportHTMLHandler);
            closePopup.addEventListener('click', hidePopup);
            
            // History controls
            undoBtn.addEventListener('click', undo);
            redoBtn.addEventListener('click', redo);

            // Image interaction
            imageContainer.addEventListener('click', addMarker);
            imageContainer.addEventListener('mousemove', handleImageMouseMove);
            imageContainer.addEventListener('mouseenter', () => isMouseOverImage = true);
            imageContainer.addEventListener('mouseleave', () => {
                isMouseOverImage = false;
                if (previewMarker) {
                    previewMarker.remove();
                    previewMarker = null;
                }
            });

            // Search
            markerSearch.addEventListener('input', filterMarkers);

            // Export modal
            copyCodeBtn.addEventListener('click', copyExportCode);
            downloadBtn.addEventListener('click', downloadExportFile);
            closeExportBtn.addEventListener('click', () => {
                document.getElementById('exportModal').classList.add('hidden');
            });

            // Initialize
            updateFieldsVisibility();
            saveToHistory();
            document.addEventListener('keydown', handleKeyboardShortcuts);
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('Please upload a valid image file');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                alert('Image file too large. Please choose a file smaller than 10MB');
                return;
            }

            // Show loading
            const originalHTML = uploadArea.innerHTML;
            uploadArea.innerHTML = '<i class="fas fa-spinner fa-spin"></i><p>Loading image...</p>';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    uploadArea.innerHTML = originalHTML;
                    
                    currentImage = {
                        src: e.target.result,
                        width: img.width,
                        height: img.height,
                        name: file.name
                    };
                    
                    imageDisplay.src = currentImage.src;
                    imageDisplay.style.display = 'block';
                    emptyState.style.display = 'none';
                    
                    document.getElementById('currentImageName').textContent = file.name;
                    document.getElementById('imageInfo').classList.remove('hidden');
                    
                    markers = [];
                    updateMarkerList();
                    renderAllMarkers();
                    saveToHistory();
                };
                img.onerror = function() {
                    uploadArea.innerHTML = originalHTML;
                    alert('Error loading image. Please try another file.');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function handleImageMouseMove(event) {
            if (!currentImage || !isMouseOverImage) return;
            
            // Remove existing preview
            if (previewMarker) {
                previewMarker.remove();
                previewMarker = null;
            }
            
            const containerRect = imageContainer.getBoundingClientRect();
            const imgRect = imageDisplay.getBoundingClientRect();
            
            // Calculate mouse position relative to image
            const mouseX = event.clientX - imgRect.left;
            const mouseY = event.clientY - imgRect.top;
            
            // Only show preview if mouse is over the image
            if (mouseX >= 0 && mouseX <= imgRect.width && mouseY >= 0 && mouseY <= imgRect.height) {
                // Calculate display position relative to container
                const displayX = event.clientX - containerRect.left;
                const displayY = event.clientY - containerRect.top;
                
                showMarkerPreview(displayX, displayY);
            }
        }

        function showMarkerPreview(x, y) {
            previewMarker = document.createElement('div');
            previewMarker.className = 'marker preview ' + currentMarkerType;
            previewMarker.style.left = x + 'px';
            previewMarker.style.top = y + 'px';
            previewMarker.innerHTML = `<i class="fas fa-${markerThemes[currentMarkerType].icon}"></i>`;
            imageContainer.appendChild(previewMarker);
        }

        function addMarker(event) {
            if (!currentImage) {
                alert('Please upload an image first!');
                return;
            }

            // Don't add marker if clicking on existing marker or popup
            if (event.target.classList.contains('marker') || 
                event.target.closest('.marker-popup')) {
                return;
            }

            // Remove preview
            if (previewMarker) {
                previewMarker.remove();
                previewMarker = null;
            }

            const containerRect = imageContainer.getBoundingClientRect();
            const imgRect = imageDisplay.getBoundingClientRect();
            
            // Calculate click position
            const clickX = event.clientX - containerRect.left;
            const clickY = event.clientY - containerRect.top;
            
            // Calculate position relative to image
            const imageRelativeX = event.clientX - imgRect.left;
            const imageRelativeY = event.clientY - imgRect.top;
            
            // Only add if within image bounds
            if (imageRelativeX < 0 || imageRelativeX > imgRect.width || 
                imageRelativeY < 0 || imageRelativeY > imgRect.height) {
                return;
            }
            
            // Convert to percentage coordinates
            const imageX = (imageRelativeX / imgRect.width) * 100;
            const imageY = (imageRelativeY / imgRect.height) * 100;

            // Create new marker
            const markerData = {
                id: Date.now() + Math.random(),
                type: currentMarkerType,
                x: imageX,
                y: imageY,
                displayX: clickX,
                displayY: clickY,
                title: `New ${currentMarkerType.charAt(0).toUpperCase() + currentMarkerType.slice(1)} Marker`,
                description: '',
                link: '',
                video: '',
                audio: ''
            };

            markers.push(markerData);
            renderMarker(markerData);
            updateMarkerList();
            saveToHistory();

            // Select and edit the new marker
            selectMarker(markerData.id);
            populateFormWithMarker(markerData);
            showMarkerInfo(markerData);
        }

        function populateFormWithMarker(marker) {
            markerTitle.value = marker.title;
            markerDescription.value = marker.description;
            markerLink.value = marker.link;
            markerVideo.value = marker.video;
            markerAudio.value = marker.audio;
            
            // Set correct marker type
            markerTypes.forEach(t => t.classList.remove('selected'));
            document.querySelector(`.marker-type[data-type="${marker.type}"]`).classList.add('selected');
            currentMarkerType = marker.type;
            updateFieldsVisibility();
            
            deleteMarker.style.display = 'inline-block';
        }

        function validateMarkerData() {
            const errors = [];
            
            if (!markerTitle.value.trim()) errors.push('Title is required');
            
            if (currentMarkerType === 'link' && markerLink.value && !isValidUrl(markerLink.value)) {
                errors.push('Valid URL required for links');
            }
            if (currentMarkerType === 'video' && markerVideo.value && !isValidUrl(markerVideo.value)) {
                errors.push('Valid URL required for videos');
            }
            if (currentMarkerType === 'audio' && markerAudio.value && !isValidUrl(markerAudio.value)) {
                errors.push('Valid URL required for audio');
            }
            
            return errors;
        }

        function isValidUrl(string) {
            if (!string) return false;
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        function renderMarker(marker) {
            const markerElement = document.createElement('div');
            markerElement.className = 'marker ' + marker.type;
            markerElement.style.left = marker.displayX + 'px';
            markerElement.style.top = marker.displayY + 'px';
            markerElement.dataset.id = marker.id;
            markerElement.innerHTML = `<i class="fas fa-${markerThemes[marker.type].icon}"></i>`;

            markerElement.addEventListener('click', (e) => {
                e.stopPropagation();
                selectMarker(marker.id);
                showMarkerInfo(marker);
            });

            imageContainer.appendChild(markerElement);
            return markerElement;
        }

        function renderAllMarkers() {
            // Clear existing markers
            document.querySelectorAll('.marker:not(.preview)').forEach(marker => marker.remove());
            
            // Recalculate positions and render
            if (currentImage) {
                const imgRect = imageDisplay.getBoundingClientRect();
                
                markers.forEach(marker => {
                    // Recalculate display position
                    const displayX = (marker.x / 100) * imgRect.width;
                    const displayY = (marker.y / 100) * imgRect.height;
                    
                    marker.displayX = displayX;
                    marker.displayY = displayY;
                    
                    renderMarker(marker);
                });
            }
        }

        function selectMarker(markerId) {
            // Deselect all
            document.querySelectorAll('.marker').forEach(m => m.classList.remove('selected'));
            document.querySelectorAll('.marker-item').forEach(m => m.classList.remove('selected'));
            
            // Select clicked marker
            const markerElement = document.querySelector(`.marker[data-id="${markerId}"]`);
            const markerItem = document.querySelector(`.marker-item[data-id="${markerId}"]`);
            
            if (markerElement) markerElement.classList.add('selected');
            if (markerItem) markerItem.classList.add('selected');
            
            selectedMarkerId = markerId;
            deleteMarker.style.display = 'inline-block';
        }

        function showMarkerInfo(marker) {
            popupTitle.textContent = marker.title;
            popupDescription.textContent = marker.description;
            
            // Clear previous media
            popupMedia.innerHTML = '';
            popupLink.style.display = 'none';
            
            // Show appropriate content
            if (marker.type === 'link' && marker.link) {
                popupLink.href = marker.link;
                popupLink.textContent = marker.link.length > 50 ? marker.link.substring(0, 50) + '...' : marker.link;
                popupLink.style.display = 'block';
            }
            else if (marker.type === 'video' && marker.video) {
                const videoElement = createMediaElement(marker.video, 'video');
                if (videoElement) {
                    popupMedia.appendChild(videoElement);
                }
            }
            else if (marker.type === 'audio' && marker.audio) {
                const audioElement = createMediaElement(marker.audio, 'audio');
                if (audioElement) {
                    popupMedia.appendChild(audioElement);
                }
            }

            // Position popup intelligently
            positionPopup(marker.displayX, marker.displayY);
        }

        function positionPopup(x, y) {
            const popupWidth = markerPopup.offsetWidth || 300;
            const popupHeight = markerPopup.offsetHeight || 200;
            const containerRect = imageContainer.getBoundingClientRect();
            
            // Try position to the right first
            let left = x + 40;
            let top = y - 20;
            
            // Adjust if goes outside container
            if (left + popupWidth > containerRect.width - 20) {
                left = x - popupWidth - 20;
            }
            if (left < 20) {
                left = 20;
            }
            
            if (top + popupHeight > containerRect.height - 20) {
                top = containerRect.height - popupHeight - 20;
            }
            if (top < 20) {
                top = 20;
            }
            
            markerPopup.style.left = left + 'px';
            markerPopup.style.top = top + 'px';
            markerPopup.style.display = 'block';
        }

        function createMediaElement(url, type) {
            if (!url) return null;
            
            if (type === 'video') {
                if (url.includes('youtube.com') || url.includes('youtu.be') || url.includes('vimeo.com')) {
                    const embedUrl = getEmbedUrl(url);
                    const videoContainer = document.createElement('div');
                    videoContainer.className = 'video-container';
                    
                    const iframe = document.createElement('iframe');
                    iframe.src = embedUrl;
                    iframe.allowFullscreen = true;
                    iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
                    
                    videoContainer.appendChild(iframe);
                    return videoContainer;
                } else {
                    const videoContainer = document.createElement('div');
                    videoContainer.className = 'video-container';
                    
                    const video = document.createElement('video');
                    video.src = url;
                    video.controls = true;
                    video.className = 'popup-video';
                    
                    videoContainer.appendChild(video);
                    return videoContainer;
                }
            } else if (type === 'audio') {
                const audio = document.createElement('audio');
                audio.src = url;
                audio.controls = true;
                audio.className = 'popup-audio';
                return audio;
            }
            
            return null;
        }

        function getEmbedUrl(url) {
            // YouTube
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                let videoId = '';
                
                if (url.includes('youtube.com/watch?v=')) {
                    const urlObj = new URL(url);
                    videoId = urlObj.searchParams.get('v');
                } else if (url.includes('youtu.be/')) {
                    const urlObj = new URL(url);
                    videoId = urlObj.pathname.substring(1);
                } else if (url.includes('youtube.com/embed/')) {
                    const urlObj = new URL(url);
                    const pathParts = urlObj.pathname.split('/');
                    videoId = pathParts[pathParts.length - 1];
                }
                
                if (videoId) {
                    const cleanVideoId = videoId.split('?')[0].split('&')[0];
                    return `https://www.youtube.com/embed/${cleanVideoId}?rel=0`;
                }
            }
            // Vimeo
            else if (url.includes('vimeo.com')) {
                let videoId = '';
                
                if (url.includes('vimeo.com/')) {
                    const urlObj = new URL(url);
                    const pathParts = urlObj.pathname.split('/');
                    videoId = pathParts[pathParts.length - 1];
                }
                
                if (videoId) {
                    return `https://player.vimeo.com/video/${videoId}`;
                }
            }
            
            return url;
        }

        function hidePopup() {
            markerPopup.style.display = 'none';
        }

        function saveMarkerHandler() {
            if (selectedMarkerId) {
                // Update existing marker
                const marker = markers.find(m => m.id === selectedMarkerId);
                if (marker) {
                    const errors = validateMarkerData();
                    if (errors.length > 0) {
                        alert('Please fix the following errors:\n' + errors.join('\n'));
                        return;
                    }
                    
                    // Update marker data
                    marker.title = markerTitle.value;
                    marker.description = markerDescription.value;
                    marker.link = markerLink.value;
                    marker.video = markerVideo.value;
                    marker.audio = markerAudio.value;
                    marker.type = currentMarkerType;
                    
                    updateMarkerList();
                    
                    // Update marker visual
                    const markerElement = document.querySelector(`.marker[data-id="${selectedMarkerId}"]`);
                    if (markerElement) {
                        markerElement.className = 'marker ' + currentMarkerType;
                        if (markerElement.classList.contains('selected')) {
                            markerElement.classList.add('selected');
                        }
                        markerElement.innerHTML = `<i class="fas fa-${markerThemes[currentMarkerType].icon}"></i>`;
                    }
                    
                    saveToHistory();
                    
                    // Update popup if open
                    if (markerPopup.style.display === 'block') {
                        showMarkerInfo(marker);
                    }
                    
                    alert('Marker updated!');
                }
            } else {
                alert('Please select a marker to edit, or click on the image to add a new marker.');
            }
        }

        function deleteMarkerHandler() {
            if (selectedMarkerId && confirm('Delete this marker?')) {
                markers = markers.filter(m => m.id !== selectedMarkerId);
                const markerElement = document.querySelector(`.marker[data-id="${selectedMarkerId}"]`);
                if (markerElement) markerElement.remove();
                updateMarkerList();
                hidePopup();
                resetForm();
                selectedMarkerId = null;
                saveToHistory();
            }
        }

        function clearMarkersHandler() {
            if (markers.length === 0) return;
            
            if (confirm('Clear all markers? This cannot be undone.')) {
                markers = [];
                document.querySelectorAll('.marker:not(.preview)').forEach(m => m.remove());
                updateMarkerList();
                hidePopup();
                resetForm();
                saveToHistory();
            }
        }

        function filterMarkers() {
            const searchTerm = markerSearch.value.toLowerCase();
            const markerItems = markerList.querySelectorAll('.marker-item');
            
            let visibleCount = 0;
            markerItems.forEach(item => {
                const title = item.querySelector('.marker-item-title').textContent.toLowerCase();
                const type = item.querySelector('.marker-item-type').textContent.toLowerCase();
                const description = item.dataset.description ? item.dataset.description.toLowerCase() : '';
                
                if (title.includes(searchTerm) || type.includes(searchTerm) || description.includes(searchTerm)) {
                    item.style.display = 'flex';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            if (visibleCount === 0 && markerSearch.value) {
                markerList.innerHTML = '<div class="empty-state">No markers found</div>';
            }
        }

        function updateMarkerList() {
            if (markers.length === 0) {
                markerList.innerHTML = '<div class="empty-state">No markers added</div>';
                document.getElementById('markerListCount').textContent = '0';
                document.getElementById('markerCount').textContent = '0';
                return;
            }

            let html = '';
            markers.forEach(marker => {
                html += `<div class="marker-item" data-id="${marker.id}" data-description="${marker.description.toLowerCase()}">
                    <div class="marker-item-header">
                        <div class="marker-item-title">
                            <i class="fas fa-${markerThemes[marker.type].icon}"></i>
                            ${marker.title}
                        </div>
                        <span class="marker-item-type">${marker.type}</span>
                    </div>
                    <div class="marker-item-description">${marker.description || 'No description'}</div>
                    <div class="marker-item-actions">
                        <button class="marker-action-btn edit" data-id="${marker.id}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="marker-action-btn delete" data-id="${marker.id}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>`;
            });

            markerList.innerHTML = html;
            document.getElementById('markerListCount').textContent = markers.length;
            document.getElementById('markerCount').textContent = markers.length;

            // Add event listeners
            markerList.querySelectorAll('.marker-item').forEach(item => {
                const markerId = parseInt(item.dataset.id);
                const marker = markers.find(m => m.id === markerId);
                
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.marker-item-actions')) {
                        selectMarker(markerId);
                        showMarkerInfo(marker);
                    }
                });
                
                item.querySelector('.edit').addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectMarker(markerId);
                    populateFormWithMarker(marker);
                });
                
                item.querySelector('.delete').addEventListener('click', (e) => {
                    e.stopPropagation();
                    markers = markers.filter(m => m.id !== markerId);
                    const markerElement = document.querySelector(`.marker[data-id="${markerId}"]`);
                    if (markerElement) markerElement.remove();
                    updateMarkerList();
                    if (selectedMarkerId === markerId) {
                        hidePopup();
                        resetForm();
                        selectedMarkerId = null;
                    }
                    saveToHistory();
                });
            });
        }

        function updateFieldsVisibility() {
            // Hide all URL fields
            markerLink.classList.remove('visible');
            markerVideo.classList.remove('visible');
            markerAudio.classList.remove('visible');
            
            // Show only the relevant field
            switch(currentMarkerType) {
                case 'link':
                    markerLink.classList.add('visible');
                    break;
                case 'video':
                    markerVideo.classList.add('visible');
                    break;
                case 'audio':
                    markerAudio.classList.add('visible');
                    break;
            }
        }

        function resetForm() {
            markerTitle.value = '';
            markerDescription.value = '';
            markerLink.value = '';
            markerVideo.value = '';
            markerAudio.value = '';
            deleteMarker.style.display = 'none';
            selectedMarkerId = null;
            
            // Deselect all markers
            document.querySelectorAll('.marker').forEach(m => m.classList.remove('selected'));
            document.querySelectorAll('.marker-item').forEach(m => m.classList.remove('selected'));
            
            // Reset to info type
            markerTypes.forEach(t => t.classList.remove('selected'));
            document.querySelector('.marker-type[data-type="info"]').classList.add('selected');
            currentMarkerType = 'info';
            updateFieldsVisibility();
            
            hidePopup();
        }

        // History management
        function saveToHistory() {
            history = history.slice(0, historyIndex + 1);
            history.push({
                markers: JSON.parse(JSON.stringify(markers)),
                image: currentImage
            });
            historyIndex++;
            updateHistoryButtons();
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                const state = history[historyIndex];
                markers = state.markers;
                renderAllMarkers();
                updateMarkerList();
                updateHistoryButtons();
            }
        }

        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                const state = history[historyIndex];
                markers = state.markers;
                renderAllMarkers();
                updateMarkerList();
                updateHistoryButtons();
            }
        }

        function updateHistoryButtons() {
            undoBtn.disabled = historyIndex <= 0;
            redoBtn.disabled = historyIndex >= history.length - 1;
        }

        // Keyboard shortcuts
        function handleKeyboardShortcuts(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        saveProjectHandler();
                        break;
                    case 'o':
                        e.preventDefault();
                        loadProjectHandler();
                        break;
                    case 'e':
                        e.preventDefault();
                        exportHTMLHandler();
                        break;
                    case 'z':
                        e.preventDefault();
                        undo();
                        break;
                    case 'y':
                        e.preventDefault();
                        redo();
                        break;
                }
            }
            
            if (e.key === 'Delete' && selectedMarkerId) {
                deleteMarkerHandler();
            }
            
            if (e.key === 'Escape') {
                hidePopup();
                resetForm();
            }
        }

        function saveProjectHandler() {
            if (!currentImage) {
                alert('Please upload an image first');
                return;
            }

            const projectName = prompt('Project name:', currentImage.name.replace(/\.[^/.]+$/, "") || 'Project');
            if (!projectName) return;

            const project = {
                name: projectName,
                image: currentImage,
                markers: markers,
                date: new Date().toISOString()
            };

            const projects = JSON.parse(localStorage.getItem('projects') || '[]');
            projects.push(project);
            localStorage.setItem('projects', JSON.stringify(projects));
            alert(`Project "${projectName}" saved!`);
        }

        function loadProjectHandler() {
            const projects = JSON.parse(localStorage.getItem('projects') || '[]');
            if (projects.length === 0) {
                alert('No saved projects found');
                return;
            }

            const projectNames = projects.map((p, i) => `${i + 1}. ${p.name} (${new Date(p.date).toLocaleDateString()})`).join('\n');
            const selection = prompt(`Available projects:\n\n${projectNames}\n\nEnter project number or name:`);
            
            let project;
            if (selection) {
                // Try to parse as number
                const index = parseInt(selection) - 1;
                if (!isNaN(index) && index >= 0 && index < projects.length) {
                    project = projects[index];
                } else {
                    // Try to find by name
                    project = projects.find(p => p.name.toLowerCase().includes(selection.toLowerCase()));
                }
            }
            
            if (project) {
                currentImage = project.image;
                markers = project.markers || [];
                
                imageDisplay.src = currentImage.src;
                imageDisplay.style.display = 'block';
                emptyState.style.display = 'none';
                
                document.getElementById('currentImageName').textContent = project.name;
                document.getElementById('imageInfo').classList.remove('hidden');
                
                setTimeout(() => {
                    renderAllMarkers();
                    updateMarkerList();
                    resetForm();
                    saveToHistory();
                    alert(`Project "${project.name}" loaded!`);
                }, 100);
            } else {
                alert('Project not found');
            }
        }

        function exportHTMLHandler() {
            if (!currentImage || markers.length === 0) {
                alert('Please create a project with markers first');
                return;
            }

            const projectName = prompt('Project name for export:', currentImage.name.replace(/\.[^/.]+$/, "") || 'Interactive Image');
            if (!projectName) return;

            const responsive = confirm('Enable responsive design for mobile devices?');
            const smartPositioning = confirm('Use smart popup positioning (avoid off-screen popups)?');
            
            const html = createExportHTML(projectName, { responsive, smartPositioning });
            document.getElementById('exportCode').value = html;
            document.getElementById('exportModal').classList.remove('hidden');
        }

        function createExportHTML(projectName, options = {}) {
            const { responsive = true, smartPositioning = true } = options;
            
            return `<!DOCTYPE html>
<html>
<head>
    <title>${projectName}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { margin: 20px; text-align: center; font-family: Arial, sans-serif; background: #f0f2f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .image-container { position: relative; display: inline-block; max-width: 100%; margin: 20px 0; }
        img { max-width: 100%; height: auto; border-radius: 5px; }
        .marker { position: absolute; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; transform: translate(-50%, -50%); display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: transform 0.2s; }
        .marker:hover { transform: translate(-50%, -50%) scale(1.2); }
        .marker.info { background: #4cc9f0; }
        .marker.link { background: #4361ee; }
        .marker.video { background: #f72585; }
        .marker.audio { background: #7209b7; }
        .marker.warning { background: #f8961e; }
        .marker.question { background: #2a9d8f; }
        .popup { position: absolute; background: white; border: 1px solid #ccc; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: none; z-index: 100; max-width: 350px; min-width: 250px; border-radius: 8px; }
        .popup-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .popup-title { color: #4a6fa5; margin: 0; flex: 1; }
        .popup-close { background: none; border: none; font-size: 18px; cursor: pointer; color: #6c757d; }
        .popup-content { margin-bottom: 15px; }
        .popup-description { color: #495057; line-height: 1.4; margin-bottom: 10px; }
        .popup-link { display: block; color: #4a6fa5; text-decoration: none; margin-bottom: 10px; word-break: break-all; }
        .popup-link:hover { text-decoration: underline; }
        .popup-media { width: 100%; margin-top: 10px; }
        .video-container { position: relative; width: 100%; height: 0; padding-bottom: 56.25%; margin-top: 10px; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; border-radius: 4px; }
        .popup-video, .popup-audio { width: 100%; border-radius: 4px; }
        ${responsive ? `
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .popup { max-width: 90vw; left: 5vw !important; }
            .marker { width: 24px; height: 24px; font-size: 12px; }
        }` : ''}
    </style>
</head>
<body>
    <div class="container">
        <h1>${projectName}</h1>
        <div class="image-container">
            <img src="${currentImage.src}" alt="${projectName}" id="exportedImage">
            <div id="markers"></div>
            <div class="popup" id="popup">
                <div class="popup-header">
                    <h4 class="popup-title" id="popupTitle"></h4>
                    <button class="popup-close" onclick="document.getElementById('popup').style.display='none'">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="popup-content">
                    <p class="popup-description" id="popupDesc"></p>
                    <a class="popup-link" id="popupLink" href="#" target="_blank" style="display: none;"></a>
                    <div class="popup-media" id="popupMedia"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const markers = ${JSON.stringify(markers)};
        const image = document.getElementById('exportedImage');
        const smartPositioning = ${smartPositioning};
        
        function createMediaElement(url, type) {
            if (type === 'video') {
                if (url.includes('youtube.com') || url.includes('youtu.be') || url.includes('vimeo.com')) {
                    const embedUrl = getEmbedUrl(url);
                    const videoContainer = document.createElement('div');
                    videoContainer.className = 'video-container';
                    
                    const iframe = document.createElement('iframe');
                    iframe.src = embedUrl;
                    iframe.allowFullscreen = true;
                    iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
                    
                    videoContainer.appendChild(iframe);
                    return videoContainer;
                } else {
                    const videoContainer = document.createElement('div');
                    videoContainer.className = 'video-container';
                    
                    const video = document.createElement('video');
                    video.src = url;
                    video.controls = true;
                    video.className = 'popup-video';
                    
                    videoContainer.appendChild(video);
                    return videoContainer;
                }
            } else if (type === 'audio') {
                const audio = document.createElement('audio');
                audio.src = url;
                audio.controls = true;
                audio.className = 'popup-audio';
                return audio;
            }
        }
        
        function getEmbedUrl(url) {
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                let videoId = '';
                
                if (url.includes('youtube.com/watch?v=')) {
                    const urlObj = new URL(url);
                    videoId = urlObj.searchParams.get('v');
                } else if (url.includes('youtu.be/')) {
                    const urlObj = new URL(url);
                    videoId = urlObj.pathname.substring(1);
                } else if (url.includes('youtube.com/embed/')) {
                    const urlObj = new URL(url);
                    const pathParts = urlObj.pathname.split('/');
                    videoId = pathParts[pathParts.length - 1];
                }
                
                if (videoId) {
                    const cleanVideoId = videoId.split('?')[0].split('&')[0];
                    return 'https://www.youtube.com/embed/' + cleanVideoId + '?rel=0';
                }
            }
            else if (url.includes('vimeo.com')) {
                let videoId = '';
                
                if (url.includes('vimeo.com/')) {
                    const urlObj = new URL(url);
                    const pathParts = urlObj.pathname.split('/');
                    videoId = pathParts[pathParts.length - 1];
                }
                
                if (videoId) {
                    return 'https://player.vimeo.com/video/' + videoId;
                }
            }
            return url;
        }
        
        function positionPopup(popup, x, y) {
            if (smartPositioning) {
                const popupWidth = popup.offsetWidth;
                const popupHeight = popup.offsetHeight;
                const container = document.querySelector('.image-container');
                const containerRect = container.getBoundingClientRect();
                
                let left = x + 40;
                let top = y - 20;
                
                if (left + popupWidth > containerRect.width) {
                    left = x - popupWidth - 20;
                }
                if (top + popupHeight > containerRect.height) {
                    top = y - popupHeight + 20;
                }
                
                popup.style.left = left + 'px';
                popup.style.top = top + 'px';
            } else {
                popup.style.left = (x + 40) + 'px';
                popup.style.top = (y - 20) + 'px';
            }
        }
        
        image.onload = function() {
            const imgRect = image.getBoundingClientRect();
            markers.forEach(marker => {
                const m = document.createElement('div');
                m.className = 'marker ' + marker.type;
                
                const x = (marker.x / 100) * imgRect.width;
                const y = (marker.y / 100) * imgRect.height;
                
                m.style.left = x + 'px';
                m.style.top = y + 'px';
                
                let icon = '';
                if (marker.type === 'info') icon = '<i class="fas fa-info-circle"></i>';
                else if (marker.type === 'link') icon = '<i class="fas fa-link"></i>';
                else if (marker.type === 'video') icon = '<i class="fas fa-video"></i>';
                else if (marker.type === 'audio') icon = '<i class="fas fa-volume-up"></i>';
                else if (marker.type === 'warning') icon = '<i class="fas fa-exclamation-triangle"></i>';
                else if (marker.type === 'question') icon = '<i class="fas fa-question-circle"></i>';
                m.innerHTML = icon;
                
                m.onclick = function(e) {
                    e.stopPropagation();
                    document.getElementById('popupTitle').textContent = marker.title;
                    document.getElementById('popupDesc').textContent = marker.description;
                    
                    const link = document.getElementById('popupLink');
                    const media = document.getElementById('popupMedia');
                    media.innerHTML = '';
                    link.style.display = 'none';
                    
                    if (marker.type === 'link' && marker.link) {
                        link.href = marker.link;
                        link.textContent = marker.link;
                        link.style.display = 'block';
                    } else if (marker.type === 'video' && marker.video) {
                        const videoElement = createMediaElement(marker.video, 'video');
                        media.appendChild(videoElement);
                    } else if (marker.type === 'audio' && marker.audio) {
                        const audioElement = createMediaElement(marker.audio, 'audio');
                        media.appendChild(audioElement);
                    }
                    
                    positionPopup(document.getElementById('popup'), x, y);
                    document.getElementById('popup').style.display = 'block';
                };
                document.getElementById('markers').appendChild(m);
            });
        };
        
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.marker') && !e.target.closest('.popup')) {
                document.getElementById('popup').style.display = 'none';
            }
        });
        
        window.addEventListener('resize', function() {
            document.getElementById('markers').innerHTML = '';
            if (image.complete) {
                image.onload();
            }
        });
    <\/script>
</body>
</html>`;
        }

        function copyExportCode() {
            const exportCode = document.getElementById('exportCode');
            exportCode.select();
            exportCode.setSelectionRange(0, 99999);
            try {
                document.execCommand('copy');
                alert('Code copied to clipboard! Save it as an HTML file.');
            } catch (err) {
                console.error('Failed to copy: ', err);
                alert('Failed to copy code. Please select and copy manually.');
            }
        }

        function downloadExportFile() {
            const exportCode = document.getElementById('exportCode').value;
            const blob = new Blob([exportCode], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const projectName = prompt('Enter filename:', currentImage?.name.replace(/\.[^/.]+$/, "") || 'interactive-image') || 'interactive-image';
            a.download = `${projectName}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if (currentImage) {
                    renderAllMarkers();
                }
            }, 250);
        });

        // Start the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
